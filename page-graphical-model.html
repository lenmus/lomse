<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lomse library. API documentation: The Graphical Model</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="lomse.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_100x195.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Lomse library. API documentation
   &#160;<span id="projectnumber">0.30.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page-graphical-model.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">The Graphical Model </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#graphical-model-intro">Structure of the Graphical Model</a></li>
<li class="level1"><a href="#graphical-model-traversing">Traversing the Graphical Model</a></li>
<li class="level1"><a href="#graphical-model-boxes">Drawing bounding boxes</a></li>
<li class="level1"><a href="#graphical-model-scroll">Scrolling the View</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="graphical-model-intro"></a>
Structure of the Graphical Model</h1>
<p>The Internal Model (IM), an abstract representation of the document content. But when the document must be displayed, it is necessary to determine the required notation symbols and how they should be arranged to create the visual representation. Instead of directly generating a bitmap with the resulting visual representation, Lomse does this in two steps.</p>
<p>First, Lomse builds from the Internal Model (IM) a graphical model (the GM): a collection of graphical objects (lines, arcs, shapes, etc.) that describe the final appearance of the score from a purely geometric point of view. The <em>Graphic Model</em> objects (GmoShape and GmoBox derived objects) behave as vertex sources, providing the coordinates for the polygons that define the visual representation of the document.</p>
<p>And once the graphical model is created, the second step, the rendering process can take place. At high level, rendering is a simple operation. It is just traversing the graphical model tree and invoking the <em>on_draw</em> method on each object.</p>
<p>Currently, the only <code><a class="el" href="classDrawer.html">Drawer</a></code> implemented in Lomse is the <code>ScreenDrawer</code> class. It is oriented to rendering on a bitmap and it is based on the AGG rendering software (<code><a href="http://www.antigrain.com/">http://www.antigrain.com/</a> &lt;<a href="http://www.antigrain.com/">http://www.antigrain.com/</a>&gt;</code>_). This class and the underlying rendering engine is described later in this chapter.</p>
<p>The converted coordinates creates a collection of polygons that define the final image to be generated. For creating the image, an scanline rendering algorithm is applied (see, for instance, <code><a href="http://en.wikipedia.org/wiki/Scanline_rendering">http://en.wikipedia.org/wiki/Scanline_rendering</a> &lt;<a href="http://en.wikipedia.org/wiki/Scanline_rendering">http://en.wikipedia.org/wiki/Scanline_rendering</a>&gt;</code>_). The result of this process is a bitmap with the image.</p>
<p>is that instead of calling any particular 3D framework directly, it just emits the vertex buffer and list of draw calls that you'd need in any 3D framework, making it very flexible. Lomse could do something similar along with also emitting the required bitmaps, which would become textures in an app's preferred graphics framework.</p>
<p>Once the Graphical Model is built it must be rebuilt only if the document changes. Other changes, such as resolution, window size, allocation a new rendering bitmap, do not affect the GM.</p>
<p>From the point of view of the rendering process the GM objects (GmoShape and GmoBox objects) behave as vertex sources, providing the coordinates for the polygons that define the visual representation of the document. In Lomse, the <em>graphical model</em>, modelled by class <a class="el" href="classGraphicModel.html">GraphicModel</a>, represents what in computer graphics theory is named the <em>real world</em>, a virtual rendition of the full document at real size (e.g. millimeters). It is a virtual image of the full document organized as expected by the chosen View type.</p>
<p>The graphical model is only built once (in method Interactor::create_graphic_model()), when a new document is loaded or it is modified. And the rendering process can be executed many times (normally when invoking <a class="el" href="classInteractor.html#a06e3f55dc1042e165adc50493d0f90b4">Interactor::redraw_bitmap()</a>). But rendition is always limited to the current viewport. Therefore, in an app in which the viewport is only half page, the other half page and all remaining pages will not be rendered.</p>
<p>Coordinates can be then converted by applying different transformations, such as scaling, rotation and shift. The converted coordinates creates a collection of polygons that define the final image to be generated. And once the graphical model is created, the rendering process can take place.</p>
<p>The graphical model is only built once (in method Interactor::create_graphic_model()), when a new document is loaded or it is modified. And the rendering process can be executed many times (normally when invoking <a class="el" href="classInteractor.html#a06e3f55dc1042e165adc50493d0f90b4">Interactor::redraw_bitmap()</a>). But rendition is always limited to the current viewport.</p>
<p>Once the Graphical Model is built all graphic information is available. But certainly some API methods to get information from the graphical model can be added. In general, user apps. do not need to interact with the GM or, at least, I never feel the need. But there are methods to get information like the one you suggest:</p>
<p>The height of the system. The baseline (or some other anchor point) of each staff in the system. The beginning/end number of the measures in that system. Some way to retrieve a list of associated horizontal pixel coordinates &amp; timepos for each measure and each beat in that measure (for manually controlling the highlight, etc.)</p>
<p>The GM subdivides the document layout in regions or @ boxes, represented by objects derived from GmoBox. The boxes are organized in a tree so that each box is also a container for other boxes. Some boxes are just auxiliary containers for shapes and thus their bounding boxes are not computed. For instance, the main boxes for an score are depicted in following pictura:</p>
<div class="image">
<img src="graphical-model-boxes.png" alt="graphical-model-boxes.png" width="700px"/>
<div class="caption">
Image: Some boxes in the Graphical Model</div></div>
<ul>
<li>GmoBoxSystem - Represents a line of music in the printed score and encloses all its content.</li>
<li>GmoBoxSlice - Systems are vertically split in columns or vertical slices. Normally, for music with time signature, a slice corresponds to a measure. GmoBoxSlice is a container for all boxes and shapes in that system column.</li>
<li>GmoBoxSliceInstr - GmoBoxSlice is horizontally subdivided in regions for each instrument in the system. GmoBoxSliceInstr represents a column of an instrument. It is a container for GmoBoxSliceStaff objects that contain the shapes for the slice.</li>
</ul>
<p>The GM uses the following boxes:</p>
<ul>
<li>GmoBoxDocument - The root of the GM. It is a container for the document pages.</li>
<li>GmoBoxDocPage - Encloses a page of the document.</li>
<li>GmoBoxDocPageContent - Encloses the content for a block in page of the document. (?)</li>
<li>GmoBoxInline - Encloses an inline element, e.g. of the document.</li>
<li>GmoBoxLink - Encloses an hyperlink.</li>
<li>GmoBoxParagraph - Encloses a paragraph.</li>
<li>GmoBoxControl - Encloses a control, e.g. a button or a check box.</li>
<li>GmoBoxTable - Encloses a table.</li>
<li>GmoBoxTableRows - Encloses a row in a table.</li>
<li>GmoBoxScorePage - Encloses a page of the score.</li>
<li>GmoBoxSystem - Represents a line of music in the printed score and encloses all its content.</li>
<li>GmoBoxSlice - Systems are vertically split in columns or vertical slices. Normally, for music with time signature, a slice corresponds to a measure. GmoBoxSlice is a container for all boxes and shapes in that system column.</li>
<li>GmoBoxSliceInstr - GmoBoxSlice is horizontally subdivided in regions for each instrument in the system. GmoBoxSliceInstr represents a column of an instrument. It is a container for GmoBoxSliceStaff objects that contain the shapes for the slice.</li>
<li>GmoBoxSliceStaff - Represents one staff in a GmoSliceInstr. It is a container for the shapes associated to that staff in the instrument, to simplify tasks requiring to access the shapes for one staff, such as moving them when the staff is moved. Its bounding box is not relevant for any task, so it is not computed.</li>
</ul>
<p>The content of a page is divided into blocks, and each block is represented by a GmoBoxDocPageContent object </p><hr/>
<p>A usefull tool for understanding the graphical model and how to access the shapes needed by an engraver or for other purposes is to generate a dump of the graphical model. For this, once the GM is built and the score is displayed just do something as:</p>
<div class="fragment"><div class="line"><a class="code" href="classGraphicModel.html">GraphicModel</a>* pGM = pInteractor-&gt;get_graphic_model();</div><div class="line"><span class="keywordtype">int</span> pages = pGM-&gt;<a class="code" href="classGraphicModel.html#a14a5d0188c0e525038ea5b933b6dd397">get_num_pages</a>();</div><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; pages; ++i)</div><div class="line">{</div><div class="line">    std::cout &lt;&lt; <span class="stringliteral">&quot;Page &quot;</span> &lt;&lt; i</div><div class="line">        &lt;&lt; <span class="stringliteral">&quot; ===================================================================&quot;</span></div><div class="line">        &lt;&lt; std::endl;</div><div class="line">    pGM-&gt;dump_page(i, std::cout);</div><div class="line">}</div></div><!-- fragment --><p>For instance, this score:</p>
<div class="image">
<img src="viewport.png" alt="viewport.png"/>
<div class="caption">
Image: The 'viewport' and the 'device window'</div></div>
<p> will generate this dump:</p>
<div class="fragment"><div class="line">Page 0 ===================================================================</div><div class="line">                    org.x        org.y     size.x      size.y</div><div class="line">-------------------------------------------------------------</div><div class="line">0 [  1] box-doc-page         0.00,       0.00,   21000.00,   29700.00</div><div class="line">  1 [  2] box-docpg-cont.   1500.00,    2000.00,   18000.00,    2735.00</div><div class="line">     2 [  6] box-score-page    1500.00,    2000.00,   18000.00,    2735.00</div><div class="line">        3 [ 10] box-system        1500.00,    2000.00,    9159.03,    2735.00</div><div class="line">           4 [ 50] staff          [0]   3044.26,    3000.00,    7614.77,     735.00</div><div class="line">           4 [ 52] text           [0]   1500.00,    3039.44,    1364.26,     407.69</div><div class="line">           4 [ 18] barline        [0]   3044.26,    3007.50,      27.00,     720.00</div><div class="line">           4 [  7] box-slice         3044.26,    2000.00,    4584.39,    2735.00</div><div class="line">              5 [  8] box-slice-intr    3044.26,    2000.00,    4584.39,    2735.00</div><div class="line">                 6 [  9] box-slice-staff, idxStaff=0</div><div class="line">                    7 [ 23] clef           [0]   3179.26,    2733.50,     497.00,    1302.00</div><div class="line">                    7 [ 33] key            [0]   3856.26,    3000.00,       0.00,       0.00</div><div class="line">                    7 [ 54] time           [0]   4036.26,    3002.50,     319.00,     731.00</div><div class="line">                    7 [ 32] invisible      [0]   4805.26,    3007.50,       0.00,     720.00</div><div class="line">                    7 [ 38] (6)note           [0]   4850.26,    3274.50,     219.00,     723.00, s=630.00</div><div class="line">                    7 [ 38] (6)note           [0]   5782.05,    3274.50,     219.00,     723.00, s=630.00</div><div class="line">                    7 [ 32] invisible      [0]   6668.85,    3007.50,       0.00,     720.00</div><div class="line">                    7 [ 38] (6)note           [0]   6713.85,    3274.50,     219.00,     723.00, s=630.00</div><div class="line">                    7 [ 18] barline        [0]   7601.64,    3007.50,      27.00,     720.00</div><div class="line">                    7 [ 59] wedge          [0]   4805.26,    2557.50,    1863.59,     270.00</div><div class="line">           4 [  7] box-slice         7628.64,    2000.00,    3030.39,    2735.00</div><div class="line">              5 [  8] box-slice-intr    7628.64,    2000.00,    3030.39,    2735.00</div><div class="line">                 6 [  9] box-slice-staff, idxStaff=0</div><div class="line">                    7 [ 32] invisible      [0]   7628.64,    3007.50,       0.00,     720.00</div><div class="line">                    7 [ 38] (6)note           [0]   7880.64,    3274.50,     219.00,     723.00, s=630.00</div><div class="line">                    7 [ 38] (6)note           [0]   8812.44,    3274.50,     219.00,     723.00, s=630.00</div><div class="line">                    7 [ 32] invisible      [0]   9699.23,    3007.50,       0.00,     720.00</div><div class="line">                    7 [ 38] (6)note           [0]   9744.23,    3274.50,     219.00,     723.00, s=630.00</div><div class="line">                    7 [ 18] barline        [0]  10632.03,    3007.50,      27.00,     720.00</div><div class="line">                    7 [ 59] wedge          [0]   7628.64,    2557.50,    2070.59,     270.00</div></div><!-- fragment --><p>Notice the invisible shape for the ImoDirection with the wedge after the time signature shape, and again a new invisible shape for the ImoDirection with the end of the wedge, before the note. The last StaffObj shape in first measure is the barline shape and after it the shapes for AuxObjs/RelObjs are adde to the list. So after the barline shape it is the wedge shape.</p>
<p>Thus if the engraver receives the BoxSlice associated to each StaffObj in the relation, it will have access to the shapes for the StaffObjs before and after the ImoDirectio and well as any other shape.</p>
<p>The knowledge to traverse the GM should not be placed on the engravers but in the GM. Thus, I foresee a method to locate a shape as well as methods to locate shapes after or before a given shape.</p>
<h1><a class="anchor" id="graphical-model-traversing"></a>
Traversing the Graphical Model</h1>
<p>The GM was designed to satisfy three needs:</p><ul>
<li>For rendition: the GM should be traversed and each object should render itself.</li>
<li>In interactive applications it should not be complex to relate a mouse click position (pixels coordinates) to the inner box containing that point and the nearest shape. Or to locate the shapes inside a selection rectangle.</li>
<li>An it was also necessary to support locating the shapes created by an ImoObj.</li>
</ul>
<p>For rendition, each GmoBox is traversed and the contained shapes asked to draw themselves. No special requirements on ordering for StaffObjs shapes, thus they are currently ordered in engraving order. But other shapes must be ordered in z-order (bottom layer first). As z-order is taken into account by AuxObjs engravers, shapes for AuxObjs must be stored in engraving order. Therefore, I do not see problems in splitting the list in two, one for StaffObjs shapes and other for AuxObjs shapes. Also I do not see problems in inserting the StaffObjs shapes in order, instead of appended at the end, to keep the list ordered by xPos if more convenient for engravers.</p>
<p>To find the Shape pointed by the mouse or inside a rectangle, in each document page (GmoBoxDocPage) there is a list containing the shapes in that page, ordered by layer and creation order. Thus, by iterating this list it is easy to find the shape at the given point. This is slow for other tasks, but not for user interaction related methods. This list is redundant and could be removed to save memory, as the same results can be obtained traversing the boxes and the contained shapes. But I postponed optimizations until I had a clear view of all the needs and Lomse was advanced enough.</p>
<p>There are two global maps <code>std::map&lt;ImoId, GmoShape*&gt;</code> and <code>std::map&lt;ImoId, GmoBox*&gt;</code> oriented to solve the needs to locate the shape or box generated by and ImoObj.</p>
<p>And, finally, the GmoBoxSystem box contains a table relating timepos to x positions, useful to locate the x left position for a note/rest or a barline. This table is mainly used for positioning the</p>
<h1><a class="anchor" id="graphical-model-boxes"></a>
Drawing bounding boxes</h1>
<p>It is also possible to force Lomse to render the bounding box for GmoBoxes as well as for the shapes.</p>
<p>To draw the bounding box of all shape objects it is necessary to set that option, at Lomse library level, before generating the GM. To do it:</p>
<div class="fragment"><div class="line"><a class="code" href="classLomseDoorway.html">LomseDoorway</a>&amp; lomse = ...</div><div class="line">LibraryScope* pScope = lomse.<a class="code" href="classLomseDoorway.html#ab34d07713083fd7c37f940661bb098f7">get_library_scope</a>();</div><div class="line">pScope-&gt;set_draw_shape_bounds(<span class="keyword">true</span>);</div></div><!-- fragment --><p>To draw the bounding box of all GmoBox objects of a certain class you can request it via the interactor, specifying the box types. To do it:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;<a class="code" href="classPresenter.html#a3542802890a4615d251a5a786cee62b5">get_interactor</a>(0).lock())</div><div class="line">{</div><div class="line">    spInteractor-&gt;reset_boxes_to_draw();</div><div class="line">    spInteractor-&gt;set_box_to_draw(GmoObj::GmoBoxSlice);</div><div class="line">}</div></div><!-- fragment --><p>And to remove the boxes: </p><div class="fragment"><div class="line">spInteractor-&gt;reset_boxes_to_draw();</div></div><!-- fragment --><h1><a class="anchor" id="graphical-model-scroll"></a>
Scrolling the View</h1>
<p>Deciding the shift amount for an scroll operation once the window width/heigh is known, is just deciding how many scroll steps are convenient for a smooth and fast enough scrolling of a whole window, and dividing the window width/heigh by the chosen number of steps. As applications normally use physical units (pixels) for managing the window (e.g. mouse click points, window size) it was considered simpler and more convenient to manage the viewport also in physical units (pixels). Thus, all methods related to the viewports use pixels, e.g. moving viewport origin:</p>
<div class="fragment"><div class="line"><a class="code" href="classInteractor.html#a0eb3195aed54028cc3f250c38029e8f8">Interactor::new_viewport</a>(Pixels x, Pixels y, <span class="keywordtype">bool</span> fForceRedraw=<span class="keyword">true</span>)</div></div><!-- fragment --><p>Also, methods related to this, such as determining the total width/heigh of the View for properly positioning scrollbars and their sizes, such as method:</p>
<div class="fragment"><div class="line"><a class="code" href="classInteractor.html#a331181fe34d2f9399578bbe4be3f5f65">Interactor::get_view_size</a>(Pixels* xWidth, Pixels* yHeight)</div></div><!-- fragment --><p>also provides measurements in pixels.</p>
<p>Nevertheless, if for your application it is more convenient to use logical units to manage scrolling and the viewport, this can also be achieved by converting logical units to pixels before invoking viewport related methods, e.g. by using:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="classInteractor.html#a01daf65c15286881cd66098de1ba9ce2">Interactor::model_point_to_device</a>(<span class="keywordtype">double</span>* x, <span class="keywordtype">double</span>* y, <span class="keywordtype">int</span> iPage)</div><div class="line">UPoint <a class="code" href="classInteractor.html#a986167b680f97ad5914c69343a7d15c5">Interactor::screen_point_to_model_point</a>(Pixels x, Pixels y)</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Overview</a></li>
    <li class="footer">Generated on Tue Oct 25 2022 19:12:48 for Lomse library. API documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
