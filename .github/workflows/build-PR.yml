name: Build PR

on:
  push:
    branches:
      - 'master'
  pull_request:

jobs:
  unix:
    strategy:
      matrix:
        os: [ubuntu, macos]
        compiler: [g++, clang++]
        exclude:
          - os: macos
            compiler: g++

    name: ${{matrix.os}} (${{matrix.compiler}})

    runs-on: ${{matrix.os}}-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        shell: bash
        run: |
            if [ "$RUNNER_OS" == "Linux" ]; then
                sudo apt-get update
                sudo apt-get install --yes libfreetype6-dev libpng++-dev zlib1g-dev libunittest++-dev libfontconfig1-dev
                sudo apt-get install --yes fonts-noto-cjk
            elif [ "$RUNNER_OS" == "macOS" ]; then
                brew install cmake
                brew install fontconfig
                brew install libpng
                brew install zlib
                brew install freetype
                brew install unittest-cpp
            else
                echo "$RUNNER_OS not supported"
                exit 1
            fi

      - name: Build
        shell: bash
        run: |
            export CXX=${{matrix.compiler}}
            $CXX --version
            mkdir build && cd build
            cmake -G "Unix Makefiles" -DLOMSE_RUN_TESTS=OFF ..
            make

      - name: Run tests
        shell: bash
        run: |
            ./testlib; if [ $? -ne 0 ]; then ./testlib -v; exit 1; fi

#      - name: Upload logs on fail
#        if: ${{ failure() }}
#        uses: actions/upload-artifact@v3
#        with:
#          name: Build failure logs
#          path: ${{ runner.temp }}/build_logs

