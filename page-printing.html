<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lomse library. API documentation: Printing documents overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="lomse.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_100x195.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Lomse library. API documentation
   &#160;<span id="projectnumber">0.29.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page-printing.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Printing documents overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#page-printing-overview">The print API</a></li>
<li class="level1"><a href="#page-printing-buffer-size">Determining print buffer size</a></li>
<li class="level1"><a href="#page-printing-tiles">Save memory by tiling</a></li>
<li class="level1"><a href="#page-printing-other">Other ways of printing</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="page-printing-overview"></a>
The print API</h1>
<p>Lomse is platform independent code and knows nothing about how to print in the operating system used by your application. Therefore, it is your application responsibility to implement printing. Lomse just offers some supporting methods so that implementing printing does not require much work. The default solution offered by Lomse for implementing printing in your application is based on printing bitmaps. Nevertheless, any user application can implement its own drawer classes and do all drawing natively without having to use bitmaps and the BitmapDrawer class implemented by Lomse.</p>
<p>The Lomse print API is four methods, invoked in sequence:</p>
<ol type="1">
<li>First, determine how many pages to print. To know how many pages the document has, just call <a class="el" href="classInteractor.html#a4030a9cf2342d198a5890c30cecec4b7">Interactor::get_num_pages()</a>.</li>
<li>In order to not interfere with screen display, a different rendering buffer and resolution are used by Lomse for printing. Therefore, you will have to:<ul>
<li>Determine the current settings for printer resolution.</li>
<li>Determine the paper size, in pixels, based on printer resolution and the paper size that is going to be used, and inform Lomse by invoking Interactor::set_print_paper_size(). Lomse will automatically scale the score pages so that the fit on the specified size.</li>
<li>Determine the bitmap size to used (see <a class="el" href="page-printing.html#page-printing-buffer-size">Determining print buffer size</a>), allocate memory for this buffer and inform Lomse by invoking Interactor::set_printing_buffer().</li>
</ul>
</li>
<li>Now, invoke <a class="el" href="classInteractor.html#a45f7fb6d5f2a8b0b6d4b5e670c96e06d">Interactor::print_page()</a> to request Lomse to render a page in the provided buffer.</li>
<li>Finally, print the bitmap using the facilities of your operating system.</li>
</ol>
<p>Normally, your application will have to do the last two steps as many times as pages to print.</p>
<p>Example (using wxWidgets, adapt for your framework/OS):</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> DocumentWindow::print_page(PrinterDC* pDC, <span class="keywordtype">int</span> page, <span class="keywordtype">int</span> paperWidthPixels,</div><div class="line">                                <span class="keywordtype">int</span> paperHeightPixels)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (!m_pPresenter)</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;get_interactor(0).lock())</div><div class="line">    {</div><div class="line">        pDC-&gt;SetBackground(*WHITE_BRUSH);</div><div class="line">        pDC-&gt;Clear();</div><div class="line"></div><div class="line">        <span class="comment">//inform Lomse about printer resolution</span></div><div class="line">        spInteractor-&gt;set_print_page_size(paperWidthPixels, paperHeightPixels);</div><div class="line"></div><div class="line">        <span class="comment">//allocate print buffer</span></div><div class="line">        Bitmap img(paperWidthPixels, paperHeightPixels);</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pdata = img.GetBuffer();    <span class="comment">//ptr to the real bytes buffer</span></div><div class="line">        spInteractor-&gt;set_print_buffer(pdata, paperWidthPixels, paperHeightPixels);</div><div class="line"></div><div class="line">        <span class="comment">//render page on bitmap</span></div><div class="line">        spInteractor-&gt;print_page(page-1);</div><div class="line"></div><div class="line">        <span class="comment">//and send it to the printer</span></div><div class="line">        pDC-&gt;DrawBitmap(img, 0, 0);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="page-printing-buffer-size"></a>
Determining print buffer size</h1>
<p>The necesary bitmap size depends on the desired printing resolution and paper size. Take, for example, a sheet of DIN A4 paper; it measures 210mm X 297mm. For printing on it, the necessary bitmap size will depend on the required resolution, as given by this formula: </p><pre class="fragment">pixels = size(mm) * resolution (dpi) / 25,4 
</pre><p>For instance, here you have the required bitmap sizes for some printing resolutions:</p>
<table class="doxtable">
<tr>
<th>Printing resolution </th><th>Bitmap size for A4 paper  </th></tr>
<tr>
<td>72 dpi </td><td>595 x 842 pixels </td></tr>
<tr>
<td>150 dpi </td><td>1240 x 1754 pixels </td></tr>
<tr>
<td>300 dpi </td><td>2480 x 3508 pixels </td></tr>
<tr>
<td>600 dpi </td><td>4960 x 7016 pixels </td></tr>
</table>
<p>A list of paper sizes can be found <a href="https://en.wikipedia.org/wiki/Paper_size">here</a>.</p>
<p>Probably, when a print operation is requested, your operating system has methods for determining the required buffer size and printer resolution, so your application will not have to do the computations.</p>
<h1><a class="anchor" id="page-printing-tiles"></a>
Save memory by tiling</h1>
<p>Using large size papers or printing at very high resolutions can require huge bitmaps. A technique for avoiding this is to split the page in tiles and print tile by tile. To avoid artifacts in the borders of each tile (due to anti-aliasing) it is recommended to add a border to each tile and discard it once Lomse has rendered on the tile. Here you have an example using the wxWidgets framework:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> DocumentWindow::print_page(PrinterDC* pDC, <span class="keywordtype">int</span> page, <span class="keywordtype">int</span> paperWidthPixels,</div><div class="line">                                <span class="keywordtype">int</span> paperHeightPixels)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (!m_pPresenter)</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;get_interactor(0).lock())</div><div class="line">    {</div><div class="line">        pDC-&gt;SetBackground(*WHITE_BRUSH);</div><div class="line">        pDC-&gt;Clear();</div><div class="line"></div><div class="line">        <span class="comment">//inform Lomse about printer resolution</span></div><div class="line">        spInteractor-&gt;set_print_page_size(paperWidthPixels, paperHeightPixels);</div><div class="line"></div><div class="line">        <span class="comment">//determine tile size (pixels)</span></div><div class="line">        <span class="keywordtype">int</span> width = min(1024, paperWidthPixels);</div><div class="line">        <span class="keywordtype">int</span> height = min(1024, paperHeightPixels);</div><div class="line">        <span class="keywordtype">int</span> border = 8;</div><div class="line">        <span class="keywordflow">if</span> (width &lt; 1024 &amp;&amp; height &lt; 1024)</div><div class="line">            border = 0;</div><div class="line"></div><div class="line">        <span class="comment">// B = border, w = width</span></div><div class="line">        <span class="comment">//From paper viewpoint, for copying a tile into paper, copy origin is</span></div><div class="line">        <span class="comment">//at (B, B) and copy size is (w-2B, h-2B). Initial paper org is at (0,0).</span></div><div class="line">        <span class="comment">//From render viewpoint, initial viewport origin is at (B, B) and tiles</span></div><div class="line">        <span class="comment">//size (for advancing viewport origin) is also (w-2B, h-2B).</span></div><div class="line">        VPoint viewport(0,0);</div><div class="line">        VPoint paperPos(0,0);</div><div class="line">        <span class="keywordtype">int</span> tileW = width - 2 * border;</div><div class="line">        <span class="keywordtype">int</span> tileH = height - 2 * border;</div><div class="line"></div><div class="line">        <span class="comment">//determine how many tiles to print</span></div><div class="line">        <span class="keywordtype">int</span> rows = int( ceil(<span class="keywordtype">float</span>(paperHeightPixels) / <span class="keywordtype">float</span>(tileH)) );</div><div class="line">        <span class="keywordtype">int</span> cols = int( ceil(<span class="keywordtype">float</span>(paperWidthPixels) / <span class="keywordtype">float</span>(tileW)) );</div><div class="line"></div><div class="line">        <span class="comment">//determine last row and last column tile sizes</span></div><div class="line">        <span class="keywordtype">int</span> lastW = paperWidthPixels - tileW * (cols - 1);</div><div class="line">        <span class="keywordtype">int</span> lastH = paperHeightPixels - tileH * (rows - 1);</div><div class="line"></div><div class="line">        <span class="comment">//allocate print buffer</span></div><div class="line">        Bitmap img(width, height);</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pdata = img.GetBuffer();    <span class="comment">//ptr to the real bytes buffer</span></div><div class="line">        spInteractor-&gt;set_print_buffer(pdata, width, height);</div><div class="line"></div><div class="line">        <span class="comment">//loop to print tiles.</span></div><div class="line">        MemoryDC memoryDC;</div><div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iRow=0; iRow &lt; rows; ++iRow)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iCol=0; iCol &lt; cols; ++iCol)</div><div class="line">            {</div><div class="line">                spInteractor-&gt;print_page(page-1, viewport);</div><div class="line"></div><div class="line">                <span class="comment">//print this tile</span></div><div class="line">                <span class="keywordtype">int</span> tileWidth = (iCol == cols-1 ? lastW : tileW);</div><div class="line">                <span class="keywordtype">int</span> tileHeight = (iRow == rows-1 ? lastH : tileH);</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (border &gt; 0)</div><div class="line">                {</div><div class="line">                    memoryDC.SelectObjectAsSource(img);</div><div class="line">                    pDC-&gt;Blit(paperPos.x, paperPos.y, tileWidth, tileHeight,</div><div class="line">                              &amp;memoryDC, border, border);</div><div class="line">                    memoryDC.ReleaseSelectedObject();</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                    pDC-&gt;DrawBitmap(bitmap, paperPos.x, paperPos.y);</div><div class="line"></div><div class="line">                <span class="comment">//advance origin by tile size</span></div><div class="line">                viewport.x += tileW;</div><div class="line">                paperPos.x += tileW;</div><div class="line">            }</div><div class="line">            <span class="comment">//start new row</span></div><div class="line">            viewport.x = 0;</div><div class="line">            viewport.y += tileH;</div><div class="line">            paperPos.x = 0;</div><div class="line">            paperPos.y += tileH;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="page-printing-other"></a>
Other ways of printing</h1>
<p>If you do not like the idea of using bitmaps for printing it is feasible to write a Driver class to perform printing using methods specific to your application and operating system. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Overview</a></li>
    <li class="footer">Generated on Fri Mar 18 2022 10:45:30 for Lomse library. API documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
