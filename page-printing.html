<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>Lomse library. API documentation: Printing documents overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="lomse.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_100x195.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Lomse library. API documentation
   &#160;<span id="projectnumber">0.25.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Overview</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="modules.html"><span>Types&#160;and&#160;constants</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li class="current"><a href="pages.html"><span>Other</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page-printing.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Printing documents overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#print-overview">The print API</a></li>
<li class="level1"><a href="#print-buffer-size">Determining print buffer size</a></li>
<li class="level1"><a href="#print-tiles">Save memory by tiling</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="print-overview"></a>
The print API</h1>
<p>Lomse is platform independent code and knows nothing about how to print in the operating system used by your application. Therefore, it is your application responsibility to implement printing. Lomse just offers some supporting methods so that implementing printing does not require much work. In fact, implementing printing in your application is just printing bitmaps.</p>
<p>The Lomse print API consists in four methods, invoked in sequence:</p>
<ol type="1">
<li>First, determine how many pages to print. To know how many pages the document has, just call <a class="el" href="classInteractor.html#a4030a9cf2342d198a5890c30cecec4b7">Interactor::get_num_pages()</a>.</li>
<li>In order to not interfere with screen display, a different rendering buffer and resolution are used by Lomse for printing. Therefore, you will have to:<ul>
<li>Determine the current settings for printer resolution and inform Lomse by invoking <a class="el" href="classInteractor.html#a56006a47ef6164ad139c2d5bb1e17c3d">Interactor::set_print_ppi()</a>.</li>
<li>Determine the bitmap size to used (see <a class="el" href="page-printing.html#print-buffer-size">Determining print buffer size</a>), allocate memory for this buffer and inform Lomse by invoking Interactor::set_printing_buffer().</li>
</ul>
</li>
<li>Now, invoke <a class="el" href="classInteractor.html#a45f7fb6d5f2a8b0b6d4b5e670c96e06d">Interactor::print_page()</a> to request Lomse to render a page in the provided buffer.</li>
<li>Finally, print the bitmap using the facilities of your operating system.</li>
</ol>
<p>Normally, your application will have to do the last two steps as many times as pages to print.</p>
<p>Example:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> DocumentWindow::print_page(PrinterDC* pDC, <span class="keywordtype">int</span> page, <span class="keywordtype">int</span> paperWidthPixels,</div>
<div class="line">                                <span class="keywordtype">int</span> paperHeightPixels)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!m_pPresenter)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;get_interactor(0).lock())</div>
<div class="line">    {</div>
<div class="line">        pDC-&gt;SetBackground(*WHITE_BRUSH);</div>
<div class="line">        pDC-&gt;Clear();</div>
<div class="line"></div>
<div class="line">        <span class="comment">//inform Lomse about printer resolution</span></div>
<div class="line">        <span class="keywordtype">int</span> dpi = pDC-&gt;GetPPI();</div>
<div class="line">        spInteractor-&gt;set_print_ppi( <span class="keywordtype">double</span>(dpi) );</div>
<div class="line"></div>
<div class="line">        <span class="comment">//allocate print buffer</span></div>
<div class="line">        RenderingBuffer rbuf_print;</div>
<div class="line"><span class="preprocessor">        #define BYTES_PP 3      //3 bytes per pixel (RGB 24-bits). This must be the</span></div>
<div class="line"><span class="preprocessor"></span>                                <span class="comment">//same format that was set when initializing Lomse</span></div>
<div class="line">        <span class="keywordtype">int</span> stride = paperWidthPixels * BYTES_PP;          <span class="comment">//number of bytes per row</span></div>
<div class="line"></div>
<div class="line">        Bitmap img(paperWidthPixels, paperHeightPixels);</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pdata = img.GetBuffer();    <span class="comment">//ptr to the real bytes buffer</span></div>
<div class="line">        rbuf_print.attach(pdata, paperWidthPixels, paperHeightPixels, stride);</div>
<div class="line">        spInteractor-&gt;set_print_buffer(&amp;rbuf_print);</div>
<div class="line"></div>
<div class="line">        <span class="comment">//render page on bitmap</span></div>
<div class="line">        spInteractor-&gt;print_page(page-1);</div>
<div class="line"></div>
<div class="line">        <span class="comment">//and send it to the printer</span></div>
<div class="line">        pDC-&gt;DrawBitmap(img, 0, 0);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="print-buffer-size"></a>
Determining print buffer size</h1>
<p>The necesary bitmap size depends on the desired printing resolution and paper size.</p>
<p>For instance, a sheet of DIN A4 paper measures 210mm X 297mm. For printing on it the necessary bitmap size will depend on the required resolution, as given by this formula: </p>
<pre class="fragment">pixels = size(mm) * resolution (dpi) / 25,4 
</pre><p>For instance, here you have the required bitmap sizes for some printing resolutions:</p>
<table class="doxtable">
<tr>
<th>Printing resolution </th><th>Bitmap size for A4 paper  </th></tr>
<tr>
<td>72 dpi </td><td>595 x 842 pixels </td></tr>
<tr>
<td>150 dpi </td><td>1240 x 1754 pixels </td></tr>
<tr>
<td>300 dpi </td><td>2480 x 3508 pixels </td></tr>
<tr>
<td>600 dpi </td><td>4960 x 7016 pixels </td></tr>
</table>
<p>A list of paper sizes can be found <a href="https://en.wikipedia.org/wiki/Paper_size">here</a>.</p>
<p>Probably, when a print operation is requested, your operating system has methods for determining the required buffer size and printer resolution, so your application will not have to do the computations.</p>
<h1><a class="anchor" id="print-tiles"></a>
Save memory by tiling</h1>
<p>Using large size papers or printing at very high resolutions can require huge bitmaps. A technique for avoiding this is to split the page in tiles and print tile by tile. To avoid artifacts in the borders of each tile (due to anti-aliasing) it is recommended to add a border to each tile and discard it once Lomse has rendered on the tile. Here you have an example:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> DocumentWindow::print_page(PrinterDC* pDC, <span class="keywordtype">int</span> page, <span class="keywordtype">int</span> paperWidthPixels,</div>
<div class="line">                                <span class="keywordtype">int</span> paperHeightPixels)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!m_pPresenter)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;get_interactor(0).lock())</div>
<div class="line">    {</div>
<div class="line">        pDC-&gt;SetBackground(*WHITE_BRUSH);</div>
<div class="line">        pDC-&gt;Clear();</div>
<div class="line"></div>
<div class="line">        <span class="comment">//inform Lomse about printer resolution</span></div>
<div class="line">        <span class="keywordtype">int</span> dpi = pDC-&gt;GetPPI();</div>
<div class="line">        spInteractor-&gt;set_print_ppi( <span class="keywordtype">double</span>(dpi) );</div>
<div class="line"></div>
<div class="line">        <span class="comment">//determine tile size (pixels)</span></div>
<div class="line">        <span class="keywordtype">int</span> width = min(1024, paperWidthPixels);</div>
<div class="line">        <span class="keywordtype">int</span> height = min(1024, paperHeightPixels);</div>
<div class="line">        <span class="keywordtype">int</span> border = 8;</div>
<div class="line">        <span class="keywordflow">if</span> (width &lt; 1024 &amp;&amp; height &lt; 1024)</div>
<div class="line">            border = 0;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// B = border, w = width</span></div>
<div class="line">        <span class="comment">//From paper viewpoint, for copying a tile into paper, copy origin is</span></div>
<div class="line">        <span class="comment">//at (B, B) and copy size is (w-2B, h-2B). Initial paper org is at (0,0).</span></div>
<div class="line">        <span class="comment">//From render viewpoint, initial viewport origin is at (B, B) and tiles</span></div>
<div class="line">        <span class="comment">//size (for advancing viewport origin) is also (w-2B, h-2B).</span></div>
<div class="line">        VPoint viewport(0,0);</div>
<div class="line">        VPoint paperPos(0,0);</div>
<div class="line">        <span class="keywordtype">int</span> tileW = width - 2 * border;</div>
<div class="line">        <span class="keywordtype">int</span> tileH = height - 2 * border;</div>
<div class="line"></div>
<div class="line">        <span class="comment">//determine how many tiles to print</span></div>
<div class="line">        <span class="keywordtype">int</span> rows = int( ceil(<span class="keywordtype">float</span>(paperHeightPixels) / <span class="keywordtype">float</span>(tileH)) );</div>
<div class="line">        <span class="keywordtype">int</span> cols = int( ceil(<span class="keywordtype">float</span>(paperWidthPixels) / <span class="keywordtype">float</span>(tileW)) );</div>
<div class="line"></div>
<div class="line">        <span class="comment">//determine last row and last column tile sizes</span></div>
<div class="line">        <span class="keywordtype">int</span> lastW = paperWidthPixels - tileW * (cols - 1);</div>
<div class="line">        <span class="keywordtype">int</span> lastH = paperHeightPixels - tileH * (rows - 1);</div>
<div class="line"></div>
<div class="line">        <span class="comment">//allocate print buffer</span></div>
<div class="line">        RenderingBuffer rbuf_print;</div>
<div class="line"><span class="preprocessor">        #define BYTES_PP 3      //3 bytes per pixel (RGB 24-bits). This must be the</span></div>
<div class="line"><span class="preprocessor"></span>                                <span class="comment">//same format that was set when initializing Lomse</span></div>
<div class="line">        <span class="keywordtype">int</span> stride = width * BYTES_PP;          <span class="comment">//number of bytes per row</span></div>
<div class="line"></div>
<div class="line">        Bitmap img(width, height);</div>
<div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pdata = img.GetBuffer();    <span class="comment">//ptr to the real bytes buffer</span></div>
<div class="line">        rbuf_print.attach(pdata, width, height, stride);</div>
<div class="line">        spInteractor-&gt;set_print_buffer(&amp;rbuf_print);</div>
<div class="line"></div>
<div class="line">        <span class="comment">//loop to print tiles.</span></div>
<div class="line">        MemoryDC memoryDC;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iRow=0; iRow &lt; rows; ++iRow)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iCol=0; iCol &lt; cols; ++iCol)</div>
<div class="line">            {</div>
<div class="line">                spInteractor-&gt;print_page(page-1, viewport);</div>
<div class="line"></div>
<div class="line">                <span class="comment">//print this tile</span></div>
<div class="line">                <span class="keywordtype">int</span> tileWidth = (iCol == cols-1 ? lastW : tileW);</div>
<div class="line">                <span class="keywordtype">int</span> tileHeight = (iRow == rows-1 ? lastH : tileH);</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span> (border &gt; 0)</div>
<div class="line">                {</div>
<div class="line">                    memoryDC.SelectObjectAsSource(img);</div>
<div class="line">                    pDC-&gt;Blit(paperPos.x, paperPos.y, tileWidth, tileHeight,</div>
<div class="line">                              &amp;memoryDC, border, border);</div>
<div class="line">                    memoryDC.ReleaseSelectedObject();</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    pDC-&gt;DrawBitmap(bitmap, paperPos.x, paperPos.y);</div>
<div class="line"></div>
<div class="line">                <span class="comment">//advance origin by tile size</span></div>
<div class="line">                viewport.x += tileW;</div>
<div class="line">                paperPos.x += tileW;</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">//start new row</span></div>
<div class="line">            viewport.x = 0;</div>
<div class="line">            viewport.y += tileH;</div>
<div class="line">            paperPos.x = 0;</div>
<div class="line">            paperPos.y += tileH;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Overview</a></li>
    <li class="footer">Generated on Thu Jul 12 2018 15:27:04 for Lomse library. API documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
