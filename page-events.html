<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lomse library. API documentation: Events and Requests</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="lomse.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_100x195.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Lomse library. API documentation
   &#160;<span id="projectnumber">0.29.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page-events.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Events and Requests </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#notifications">Notifications: events and requests</a></li>
<li class="level1"><a href="#handling-events">Events and how to handle them</a></li>
<li class="level1"><a href="#events-list">Events and how are they notified</a></li>
<li class="level1"><a href="#event-handlers">How to register an event handler</a></li>
<li class="level1"><a href="#handling-requests">Handling requests</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="notifications"></a>
Notifications: events and requests</h1>
<p>Lomse is platform independent code, and knows nothing about your platform mechanisms for creating events. For this reason, all Lomse communication with the user application takes place through <em>notifications</em>, implemented by invoking a callback function in your application.</p>
<p>Lomse <em>notifications</em> can be divided into two categories based on how they are created and how they are processed:</p><ul>
<li><b>Requests</b>. When Lomse needs some information or some platform dependent service it sends a <em><a class="el" href="classRequest.html">Request</a></em>. Lomse process is paused until the user application provides the requested data so that Lomse can continue.</li>
<li><b>Events</b>. They are informative notifications about something, for instance, about a mouse click. Events can refer:<ul>
<li>To a View, i.e. a <em>playback highlight</em> event, or a <em>window update</em> event.</li>
<li>To a Document or its content, i.e. a <em>mouse click</em> event; and</li>
<li>To a Control object, i.e. a click on a link control.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="handling-events"></a>
Events and how to handle them</h1>
<p>For managing events, Lomse architecture uses the observer pattern: any other object wanting to know about events must register as an observer by providing an event handler object or a callback method/function for handling the events. In theory, your application could register a handler for each event type wanting to receive.</p>
<p>But in practice, you must be aware that <b>the name event could be misleading.</b> Lomse is not an event driven library, but a collection of services that run in the user application thread from which the service is requested. While processing a service request Lomse could find important things to communicate to your application. For this Lomse will invoke a callback so that you can take note, but Lomse <b>needs</b>to continue processing the service request. Therefore:</p>
<ul>
<li>You should be aware that <b>Lomse events are not 'true' events</b>, for which the event generation code and the event processing code is decoupled. Lomse event generation is just invoking the callback handler function in your application and so, it is not decoupled from processing the event in your application.</li>
<li><b>It is your application responsibility to decouple event processing</b>, that is, your application shouldnâ€™t retain the control more time than the strictly necessary for taking note of the event. The strongly recommended way for processing Lomse events is to create an OS/application event, put it in the application events loop and return control to Lomse, so that Lomse can terminate processing the service request that originated the event.</li>
</ul>
<p>Due to this, it was decided to send all events to a single event handler, instead of using the subscription mechanism. The rationale was that a single handler would simplify the user application task of creating an OS/application event, and putting it in the application events loop. This handler, named the <em>global handler</em> for events, is set up at Lomse initialization:</p>
<div class="fragment"><div class="line"><a class="code" href="classLomseDoorway.html">LomseDoorway</a>&amp; lib = ...</div><div class="line">lib.<a class="code" href="classLomseDoorway.html#ab5e0a00a93e25a7d8b51b39302f41a15">set_notify_callback</a>(<span class="keyword">this</span>, lomse_event_handler);</div></div><!-- fragment --><p>Unfortunately, currently not all events are sent to this handler. As I was developing the library I forgot the reasoning for having created the global handler and thus, for some events created later I maintained the subscription mechanism of the observer pattern. During the library tests, with the LenMus Phonascus application, there were no problems with these events by not having decoupled its processing in the user application. And so, the subscription mechanism remained active for these events.</p>
<p>As a consequence, the situation is now a little bit confusing: some events are always sent to the global handler but other events will not be received unless your application register an specific event handler for each one of these event types. Of course you can always register the global handler as the handler for these events, but you will have to code it in your application.</p>
<p>With the exception of the <code>k_update_window_event</code> it is not mandatory to handle all other Lomse events.</p>
<h1><a class="anchor" id="events-list"></a>
Events and how are they notified</h1>
<p>Here is a list of all events, grouped by handling mechanism. For more information on each event read the class documentation for the event.</p>
<p>a) Events always sent to the global handler:</p>
<ul>
<li>All events created during playback in the Lomse sound thread:<ul>
<li><a class="el" href="classEventUpdateViewport.html">EventUpdateViewport</a> (type <code>k_update_viewport_event</code>) - Ask user app to update viewport origin using provided coordinates.</li>
<li><a class="el" href="classEventEndOfPlayback.html">EventEndOfPlayback</a> (type <code>k_end_of_playback_event</code>) - End of playback.</li>
<li>EventScoreHighlight (type <code>k_highlight_event</code>) - Event containing mainly a list of notes/rests to highlight or unhighlight</li>
</ul>
</li>
<li>Mouse clicks on links (ImoLink objects):<ul>
<li><a class="el" href="classEventMouse.html">EventMouse</a> (type <code>k_on_link_clicked_event</code>) - left click on link (ImoLink object).</li>
</ul>
</li>
<li>Some events created only when document edition is enabled:<ul>
<li><a class="el" href="classEventMouse.html">EventMouse</a> (type <code>k_show_contextual_menu_event</code>) - right click on object: contextual menu request</li>
<li><a class="el" href="classEventUpdateUI.html">EventUpdateUI</a> (type <code>k_selection_set_change</code>) - Selected objects changed</li>
<li><a class="el" href="classEventUpdateUI.html">EventUpdateUI</a> (type <code>k_pointed_object_change</code>) - Cursor pointing to a different object</li>
</ul>
</li>
</ul>
<p>b) Events for which you will have to register a handler at the event creator object (see <a class="el" href="page-events.html#event-handlers">How to register an event handler</a>):</p>
<ul>
<li>Register at the <a class="el" href="classInteractor.html">Interactor</a>:<ul>
<li><a class="el" href="classEventPaint.html">EventPaint</a> (type <code>k_update_window_event</code>) - Ask user app to update window with current bitmap. <div class="fragment"><div class="line">spInteractor-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656daf6c7408c96763e94fd2df7d6235f7a49">k_update_window_event</a>, <span class="keyword">this</span>, on_update_window);</div></div><!-- fragment --> This event is decoupled by design: user must do repaint immediately, without more delays.</li>
<li><a class="el" href="classEventPlayCtrl.html">EventPlayCtrl</a> (type <code>k_do_play_score_event</code>) - Start/resume playback</li>
<li><a class="el" href="classEventPlayCtrl.html">EventPlayCtrl</a> (type <code>k_pause_score_event</code>) - Pause playback</li>
<li><a class="el" href="classEventPlayCtrl.html">EventPlayCtrl</a> (type <code>k_stop_playback_event</code>) - Stop playback <div class="fragment"><div class="line">spInteractor-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656da57b1f32291d0c7d644177111f483a398">k_do_play_score_event</a>, <span class="keyword">this</span>, wrapper_play_score);</div><div class="line">spInteractor-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656da144a5f912218153c12ac8f00c1fb938a">k_pause_score_event</a>, <span class="keyword">this</span>, wrapper_play_score);</div><div class="line">spInteractor-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656da70fda4ac3bd78865b2b5c69b98806ffa">k_stop_playback_event</a>, <span class="keyword">this</span>, wrapper_play_score);</div></div><!-- fragment --> These events are created by ScorePlayerGui objects. These objects are only created when processing LMD files with &lt;scorePlayer&gt; tags.</li>
<li><a class="el" href="classEventControlPointMoved.html">EventControlPointMoved</a> (event type <code>k_control_point_moved_event</code>) - User moves a handler: handler released event <div class="fragment"><div class="line">spInteractor-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656da3dcb2ed46dd797f573e3bcb6c58935d1">k_control_point_moved_event</a>, <span class="keyword">this</span>, wrapper_on_command_event);</div></div><!-- fragment --> These events are created only when document edition is enabled.</li>
</ul>
</li>
<li>Register at the Document or at specific objects in the Document:<ul>
<li><a class="el" href="classEventMouse.html">EventMouse</a> (type <code>k_mouse_in_event</code>) - Mouse goes over an object</li>
<li><a class="el" href="classEventMouse.html">EventMouse</a> (type <code>k_mouse_out_event</code>) - Mouse goes out from an object</li>
<li><a class="el" href="classEventMouse.html">EventMouse</a> (type <code>k_on_click_event</code>) - Document, ImoContentObj: click on object <div class="fragment"><div class="line"><span class="comment">//example 1: register at the document</span></div><div class="line">pDoc-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656daff42cd14f9055ff12fc1465b2b5488e4">k_on_click_event</a>, <span class="keyword">this</span>, wrapper_on_click_event);</div><div class="line"><span class="comment">//example 2: register for handling events related to an specific object</span></div><div class="line">ButtonCtrl* pButton = ...</div><div class="line">pButton-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656daff42cd14f9055ff12fc1465b2b5488e4">k_on_click_event</a>, <span class="keyword">this</span>);</div><div class="line">pButton-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656da0d97a6ae325de2746db0cea3a4152226">k_mouse_in_event</a>, <span class="keyword">this</span>);</div><div class="line">pButton-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656daa4abc9bf7bcef49fed7711f1823c91f8">k_mouse_out_event</a>, <span class="keyword">this</span>);</div></div><!-- fragment --></li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="event-handlers"></a>
How to register an event handler</h1>
<p>To capture and handle an event you must register an <code>event handler</code> on the object generating the events by invoking its <code>add_event_handler()</code> method. Your handler can be:</p><ul>
<li>a C function,</li>
<li>a C++ method, or</li>
<li>a C++ object, derived form lomse::EventHandler.</li>
</ul>
<p>All Lomse objects that generate events derive from lomse::Observable class. Currently, events can be generated by the following objects:</p><ul>
<li>A View. For handling the View events you must register an <code>event handler</code> on the <a class="el" href="classInteractor.html">Interactor</a>.</li>
<li>A Document or a document object (ImoContentObj); and</li>
<li>A Control object.</li>
</ul>
<p>The parameters for the <code>add_event_handler()</code> method depends on the type of handler method. There are three possibilities:</p>
<p>a) The handler is a C function: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> add_handler(<span class="keywordtype">int</span> eventType, <span class="keywordtype">void</span> (*pt2Func)(SpEventInfo event) );</div></div><!-- fragment --><p>b) The handler is a C++ method: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> add_handler(<span class="keywordtype">int</span> eventType, <span class="keywordtype">void</span>* pThis,</div><div class="line">                 <span class="keywordtype">void</span> (*pt2Func)(<span class="keywordtype">void</span>* pObj, SpEventInfo event) );</div></div><!-- fragment --><p>c) The handler is a C++ object derived form lomse::EventHandler: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> add_handler(<span class="keywordtype">int</span> eventType, <a class="code" href="classEventHandler.html">EventHandler</a>* pHandler);</div></div><!-- fragment --><p>The parameters for these methods are:</p><ul>
<li><code>eventType</code> is the event type you wish to handle, such as a mouse click.</li>
<li><code>SpEventInfo</code> is an shared pointer to the event object. All events derive from <code>lomse::EventInfo</code> class.</li>
</ul>
<p>For the C function case:</p><ul>
<li><code>pt2Func</code> is a pointer to the C function that will handle the event. It expects only one parameter: a shared pointer to the Event object.</li>
</ul>
<p>For C++ method case:</p><ul>
<li><code>pThis</code> is a pointer to the object that will handle the event.</li>
<li><code>pt2Func</code> is a pointer to the member method that will handle the event. It must be an <b>static method</b>. It will receive as first parameter the pointer to the object, so that you can invoke non-static methods if necessary.</li>
</ul>
<p>And for the C++ object case:</p><ul>
<li><code>pHandler</code> is a pointer to an object derived from <a class="el" href="classEventHandler.html">EventHandler</a> that will handle the event. It must implement method <code>handle_event()</code>.</li>
</ul>
<p>Example:</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (SpInteractor spInteractor = m_pPresenter-&gt;get_interactor(0).lock())</div><div class="line">{</div><div class="line">    <span class="comment">//connect the View with the window buffer</span></div><div class="line">    spInteractor-&gt;set_rendering_buffer(&amp;m_rbuf_window);</div><div class="line"></div><div class="line">    <span class="comment">//register to receive some events</span></div><div class="line">    spInteractor-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656daf6c7408c96763e94fd2df7d6235f7a49">k_update_window_event</a>, <span class="keyword">this</span>, wrapper_update_window);</div><div class="line">    spInteractor-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656da57b1f32291d0c7d644177111f483a398">k_do_play_score_event</a>, <span class="keyword">this</span>, wrapper_play_score);</div><div class="line">    spInteractor-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656da144a5f912218153c12ac8f00c1fb938a">k_pause_score_event</a>, <span class="keyword">this</span>, wrapper_play_score);</div><div class="line">    spInteractor-&gt;add_event_handler(<a class="code" href="group__enumerations.html#ggabfcf510bafec7c6429906a6ecaac656da70fda4ac3bd78865b2b5c69b98806ffa">k_stop_playback_event</a>, <span class="keyword">this</span>, wrapper_play_score);</div><div class="line">    ...</div></div><!-- fragment --><h1><a class="anchor" id="handling-requests"></a>
Handling requests</h1>
<p>It is mandatory to handle Lomse requests. For this, you have to set up a callback method (at library initialization). For instance:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>MyApp</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    ...</div><div class="line">    <span class="comment">//callbacks</span></div><div class="line">    <span class="keyword">static</span> <span class="keywordtype">void</span> lomse_request_handler_method(<span class="keywordtype">void</span>* pThis, <a class="code" href="classRequest.html">Request</a>* pRequest);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> MyApp::initialize_lomse()</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="comment">//initialize the library with these values</span></div><div class="line">    m_lomse.init_library(pixel_format, resolution, reverse_y_axis, m_lomseReporter);</div><div class="line"></div><div class="line">    <span class="comment">//set callback for requests</span></div><div class="line">    m_lomse.set_request_callback(<span class="keyword">this</span>, lomse_request_handler_method);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> MyApp::lomse_request_handler_method(<span class="keywordtype">void</span>* pThis, <a class="code" href="classRequest.html">Request</a>* pRequest)</div><div class="line">{</div><div class="line">    <span class="keyword">static_cast&lt;</span>MyApp*<span class="keyword">&gt;</span>(pThis)-&gt;on_lomse_request(pRequest);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> MyApp::on_lomse_request(<a class="code" href="classRequest.html">Request</a>* pRequest)</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> type = pRequest-&gt;<a class="code" href="classRequest.html#aa1cef2d8dbdc04772277ce2ddeda6687">get_request_type</a>();</div><div class="line">    <span class="keywordflow">switch</span> (type)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> k_dynamic_content_request:</div><div class="line">            generate_dynamic_content( dynamic_cast&lt;RequestDynamic*&gt;(pRequest) );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__enumerations.html#gga0dc84b6205af6b43ac7867cd9779dfcca478758eacf0fde44f569dc2b7ead827e">k_get_font_filename</a>:</div><div class="line">            get_font_filename( dynamic_cast&lt;RequestFont*&gt;(pRequest) );</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            LogError(<span class="stringliteral">&quot;Unknown request %d&quot;</span>, type);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>Lomse will make any necessary request by invoking this callback method. Therefore, requests are always handled in a single point in your application.</p>
<p>When your callback method is invoked, it will receive as parameter an object derived from class <a class="el" href="classRequest.html">Request</a>, containing the information about the required information or platform dependent service. And Lomse process is paused until the user application provides the requested data.</p>
<p>The list of possible Requests is:</p><ul>
<li><a class="el" href="classRequestDynamic.html">RequestDynamic</a>. While parsing an LDP document, a <code>(dynamic)</code> element has been found. Lomse is requesting user application for the dynamic content that must be inserted.</li>
<li><a class="el" href="classRequestFont.html">RequestFont</a>. The font used for an element is not available in Lomse package. Lomse requests the file path for the font. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Overview</a></li>
    <li class="footer">Generated on Fri Mar 18 2022 10:45:30 for Lomse library. API documentation by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
